-- Check
if Drawing == nil then
    game:GetService("StarterGui"):SetCore("SendNotification",{
        Title = "Swexty",
        Text = "Executor unterstützt Drawing nicht.",
        Duration = 8
    })
    return
end

-- Services
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local Camera = workspace.CurrentCamera
local UIS = game:GetService("UserInputService")

-- Settings
_G.ESP = true
_G.Lock = false
_G.LockPart = "Head"

-- GUI
local gui = Instance.new("ScreenGui", game.CoreGui)

local frame = Instance.new("Frame", gui)
frame.Size = UDim2.new(0,180,0,120)
frame.Position = UDim2.new(0.05,0,0.45,0)
frame.BackgroundColor3 = Color3.fromRGB(15,15,15)

local title = Instance.new("TextLabel", frame)
title.Size = UDim2.new(1,0,0,30)
title.Text = "SWEXTY MOBILE"
title.BackgroundTransparency = 1
title.TextColor3 = Color3.fromRGB(170,0,255)

local espBtn = Instance.new("TextButton", frame)
espBtn.Size = UDim2.new(1,-10,0,35)
espBtn.Position = UDim2.new(0,5,0,35)
espBtn.Text = "ESP: ON"

local lockBtn = Instance.new("TextButton", frame)
lockBtn.Size = UDim2.new(1,-10,0,35)
lockBtn.Position = UDim2.new(0,5,0,75)
lockBtn.Text = "LOCK: OFF"

-- Drag Mobile
local dragging, dragStart, startPos

frame.InputBegan:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.Touch then
        dragging = true
        dragStart = input.Position
        startPos = frame.Position
    end
end)

UIS.InputChanged:Connect(function(input)
    if dragging and input.UserInputType == Enum.UserInputType.Touch then
        local delta = input.Position - dragStart
        frame.Position = UDim2.new(
            startPos.X.Scale,
            startPos.X.Offset + delta.X,
            startPos.Y.Scale,
            startPos.Y.Offset + delta.Y
        )
    end
end)

UIS.InputEnded:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.Touch then
        dragging = false
    end
end)

-- Buttons
espBtn.MouseButton1Click:Connect(function()
    _G.ESP = not _G.ESP
    espBtn.Text = "ESP: "..(_G.ESP and "ON" or "OFF")
end)

lockBtn.MouseButton1Click:Connect(function()
    _G.Lock = not _G.Lock
    lockBtn.Text = "LOCK: "..(_G.Lock and "ON" or "OFF")
end)

-- ESP + BOX
local ESPCache = {}

local function AddPlayer(player)
    if player == Players.LocalPlayer then return end

    local text = Drawing.new("Text")
    local box = Drawing.new("Square")

    ESPCache[player] = {text = text, box = box}

    RunService.RenderStepped:Connect(function()
        if not _G.ESP then
            text.Visible = false
            box.Visible = false
            return
        end

        if player.Character and player.Character:FindFirstChild("HumanoidRootPart") then
            local root = player.Character.HumanoidRootPart
            local head = player.Character:FindFirstChild("Head")

            local pos, onScreen = Camera:WorldToViewportPoint(root.Position)

            if onScreen then
                local size = (Camera:WorldToViewportPoint(root.Position - Vector3.new(0,3,0)).Y -
                             Camera:WorldToViewportPoint(root.Position + Vector3.new(0,3,0)).Y)

                -- Box
                box.Size = Vector2.new(size*1.5, size*2)
                box.Position = Vector2.new(pos.X - box.Size.X/2, pos.Y - box.Size.Y/2)
                box.Color = Color3.fromRGB(170,0,255)
                box.Thickness = 2
                box.Visible = true

                -- Text
                local myRoot = Players.LocalPlayer.Character and Players.LocalPlayer.Character:FindFirstChild("HumanoidRootPart")
                local dist = 0
                if myRoot then
                    dist = (root.Position - myRoot.Position).Magnitude
                end

                text.Text = player.Name.." ["..math.floor(dist).."]"
                text.Position = Vector2.new(pos.X, pos.Y - box.Size.Y/2 - 15)
                text.Center = true
                text.Outline = true
                text.Size = 14
                text.Color = Color3.fromRGB(255,80,10)
                text.Visible = true
            else
                text.Visible = false
                box.Visible = false
            end
        else
            text.Visible = false
            box.Visible = false
        end
    end)
end

for _,p in pairs(Players:GetPlayers()) do
    AddPlayer(p)
end

Players.PlayerAdded:Connect(AddPlayer)

-- LOCK (immer nächster Gegner)
local function GetClosestPlayer()
    local closest
    local dist = math.huge

    for _,v in pairs(Players:GetPlayers()) do
        if v ~= Players.LocalPlayer and v.Character and v.Character:FindFirstChild(_G.LockPart) then
            local pos, visible = Camera:WorldToViewportPoint(v.Character[_G.LockPart].Position)
            if visible then
                local mag = (Vector2.new(pos.X,pos.Y) -
                Vector2.new(Camera.ViewportSize.X/2,Camera.ViewportSize.Y/2)).Magnitude

                if mag < dist then
                    dist = mag
                    closest = v
                end
            end
        end
    end

    return closest
end

RunService.RenderStepped:Connect(function()
    if _G.Lock then
        local target = GetClosestPlayer()

        if target and target.Character and target.Character:FindFirstChild(_G.LockPart) then
            Camera.CFrame = CFrame.new(
                Camera.CFrame.Position,
                target.Character[_G.LockPart].Position
            )
        end
    end
end)
